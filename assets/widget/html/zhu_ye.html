<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>历史</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" href="../css/aui.css">
    <script src="../script/jquery.js"></script>
</head>
<style>
    .aui-row {
        width: 95%;
    }

    .aui-grid [class*=aui-col-] {
        padding: 0.3rem 0;
    }

    .k-row i {
        float: left;
        width: 20px;
    }
</style>
<div class="aui-grid" style="position: fixed;z-index: 9;">
    <div class="aui-row" style="width: 100%;">
        <div class="aui-col-xs-4" onclick="cert()">
            <div class="aui-badge">88</div>
            <i class="aui-iconfont aui-icon-mobile"></i>
            <div class="aui-grid-label">联系人</div>
        </div>
        <div class="aui-col-xs-4" onclick="star()">
            <i class="aui-iconfont aui-icon-star"></i>
            <div class="aui-grid-label">收藏</div>
        </div>
        <div class="aui-col-xs-4" onclick="calendar()">
            <i class="aui-iconfont aui-icon-calendar"></i>
            <div class="aui-grid-label">预约</div>
        </div>
        <div class="aui-col-xs-4" onclick="date()">
            <i class="aui-iconfont aui-icon-date"></i>
            <div class="aui-grid-label">提醒</div>
        </div>
        <div class="aui-col-xs-4" onclick="flag()">
            <div class="aui-badge"></div>
            <i class="aui-iconfont aui-icon-flag"></i>
            <div class="aui-grid-label">历史</div>
        </div>
        <div class="aui-col-xs-4" onclick="question()">
            <div class="aui-dot"></div>
            <i class="aui-iconfont aui-icon-question"></i>
            <div class="aui-grid-label">帮助</div>
        </div>
    </div>
</div>
<div style="overflow-x: scroll;position: relative;" id="zyzt">
    <ul class="aui-list aui-list-in" style="margin-top: 140px;position: static;" id="content">

    </ul>
</div>
<script type="text/javascript" src="../script/api.js"></script>
<script>
    var db = null;
    apiready = function () {
        api.addEventListener({
            name: 'keyback'
        }, function (ret, err) {
            return false;
        });
        window.ApiUtil = api.require('ApiUtil');
        db = api.require('db');
        console.log('init');
        init();
        api.setRefreshHeaderInfo({
            visible: true,
            //loadingImg: 'widget://image/refresh.png',
            bgColor: '#ccc',
            textColor: '#fff',
            textDown: '下拉刷新...',
            textUp: '松开刷新...',
            showTime: true
        }, function (ret, err) {
            console.log(JSON.stringify(ret));
            console.log(JSON.stringify(err));
           init();
           setTimeout(function () {
               api.refreshHeaderLoadDone();
           },2000);
        });
    };
    function openDB(callback) {
        db.openDatabase({
            name: 'contact'
        }, function (ret, err) {
            if (ret.status) {
                db.isOpen = true;
                ApiUtil.log({tag: 'openDatabase', message: ret});
                callback(true);
            } else {
                ApiUtil.log({tag: 'openDatabase', message: err});
                db.isOpen = false;
                callback(false);
            }
        });
    }
    function info(obj) {
        api.openWin({
            name: 'new',
            bgColor: "#ffffff",
            url: 'new.html',
            pageParam: {
                name: 'test',
                type:'info',
                id:$(obj).attr('data-id')
            }
        });
    }
    function init() {
        $('#content').html('');
        var sql = 'select id,name,sex,birthday,address,phone,qq,wechar,relation,love,job,shift,speciality,level,subDate,subTime,subAddress,subEvent,subContent,isCollect,isRemind from contacts';
        openDB(function (ret) {
            setTimeout(function () {
                if (ret) {
                    selectDB(sql, function (ret, res) {
                        console.log(JSON.stringify(res));
                        if (ret && res.status) {
                            var li =
                                '<li class="aui-list-item" style="margin-bottom: 25px;">' +
                                '    <div class="aui-row">' +
                                '        <div class="k-row" style="text-align: center;line-height: 4em;">' +
                                '            暂无数据，快去添加吧' +
                                '        </div>' +
                                '    </div>' +
                                '</li>';
                            if (res.data.length > 0) {
                                for (var i = 0; i < res.data.length; i++) {
                                    var user = res.data[i];
                                    li =
                                        '<li class="aui-list-item" style="margin-bottom: 25px;" data-id="'+user.id+'" onclick="info(this)">' +
                                        '    <div class="aui-row">' +
                                        '        <div class="k-row">' +
                                        '            <i class="aui-iconfont aui-icon-my"></i>' +
                                        '            <div>' + user.name + '</div>' +
                                        '        </div>' +
                                        '        <div class="k-row">' +
                                        '            <div>' + user.phone + '</div>' +
                                        '        </div>' +
                                        '        <div class="k-row">' +
                                        '            <div>' + user.subDate + '&nbsp;&nbsp;&nbsp;' + user.subTime + '&nbsp;&nbsp;&nbsp;星期' + get_xing_qi(user.subDate) + '</div>' +
                                        '        </div>' +
                                        '        <div class="k-row">' +
                                        '            <div>' + user.subEvent + '</div>' +
                                        '        </div>' +
                                        '        <div class="k-row">' +
                                        '            <div>' + user.subAddress + '</div>' +
                                        '        </div>' +
                                        '        <div class="k-row">' +
                                        '            <div>' + user.subContent + '</div>' +
                                        '        </div>' +
                                        '    </div>' +
                                        '</li>';
                                    $('#content').append(li);
                                }
                            } else {
                                $('#content').append(li);
                            }
                        }
                    })
                }
            }, 1000);
        });
    }

    function get_xing_qi(obj) {
        var w = "日一二三四五六".charAt(new Date(obj).getDay());
        return w;
    }
    function selectDB(sql, callback) {
        db.selectSql({
            name: 'contact',
            sql: sql
        }, function (ret, err) {
            if (ret.status) {
                //alert(JSON.stringify(ret));
                callback(true, ret);
            } else {
                //alert(JSON.stringify(err));
                callback(false, err);
            }
        });
    }
    function star() {
        api.execScript({
            name: 'slide',
            script: 'menus.star()'
        });
    }
    function calendar() {
        api.execScript({
            name: 'slide',
            script: 'menus.calendar()'
        });
    }
    function date() {
        api.execScript({
            name: 'slide',
            script: 'menus.date()'
        });
    }
    function flag() {
        api.execScript({
            name: 'slide',
            script: 'menus.flag()'
        });
    }
    function question() {
        api.execScript({
            name: 'slide',
            script: 'menus.question()'
        });
    }
    function cert() {
        api.execScript({
            name: 'slide',
            script: 'menus.cert()'
        });
        api.closeSlidPane();
    }

</script>
